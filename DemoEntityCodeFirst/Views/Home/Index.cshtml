
@{
    ViewBag.Title = "Index";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<h2 id="date-container"></h2>
<ul id="chart-container" style="width: 100%; height: 150px; list-style-type: none;"></ul>

<select id="select-container"></select>
<label>Experence:</label><input id="input-year" type="number" min="0" max="100" />
<button id="send">Change</button>
<div class="row form-connect">
    <div class="col-sm-9 col-md-9"><input id="input-user-name" placeholder="Input username to connect..." /></div><button class="col-sm-3 col-md-3" id="connect">Connect</button>
</div>
<div class="row frame-chat-container">
    <div class="col-sm-4 col-md-4 list-group-chat">
        <h2>User: <span id="user-name"></span></h2>
        <input id="input-group" placeholder="Input create group..."/><button id="creat-group">Creat new group</button>
        <select id="list-group"></select>
        <button id="join-group">Join to group</button>
    </div>
    <div class="col-sm-8 col-md-8 form-chat-container">
        <div class="member-action">
            <select id="select-container-member"></select><button id="add-member">+Add</button>
            <ul class="list-member-in-group"></ul>
        </div>
        <textarea class="form-chat-content" id="form-chat-content" disabled></textarea>
        <input class="input-group-lg" id="input-group-lg" placeholder="Input message..."/><button id="send-message">Send message</button>
    </div>
</div>
@section scripts {
    <!--Script references. -->
    <!--The jQuery library is required and is referenced by default in _Layout.cshtml. -->
    <!--Reference the SignalR library. -->
    <script src="~/scripts/jquery.signalR-2.2.0.min.js"></script>
    <!--Reference the autogenerated SignalR hub script. -->
    <script src="~/signalr/hubs"></script>
    <!--SignalR script to update the chat page and send messages.-->
    <script type="text/javascript">
        //Display time server
        var chat = $.connection.chatHub;
        $(document).ready(function () {
            $(function () {
                // Reference the auto-generated proxy for the hub.
                var userNameCurrent = '';
                var groupCurrent = null;
                chat.client.loadDate = function (currentDate) {
                    $("#date-container").empty();
                    $("#date-container").text(currentDate);
                }
                // Create a function that the hub can call back to display messages.
                chat.client.loadInfo = function (listPerson) {
                    $('#chart-container').empty();
                    $('#select-container').empty();
                    $('#select-container-member').empty();
                    $.each(listPerson, function (key, value) {
                        $('#chart-container').append('<li style="position: relative; padding-left: 100px;"><span style="position: absolute; left: 0;">' + value.Name + '</span>' + '<span  style="display: inline-block; height: 20px; background-color: #36A1E0; width:' + value.Experencde * 10 + 'px;"' + '></span></li>');
                        //console.log(item);
                        $('#select-container').append('<option value=' + value.ID + '>' + value.Name + '</option>');
                        $('#select-container-member').append('<option value=' + value.ID + '>' + value.Name + '</option>');
                    });
                    //listPerson.forEach(function (item) {

                    //});
                }
                //Create user name
                chat.client.showUserName = function (userName, listGroup) {
                    console.log('test');
                    $('#user-name').empty();
                    $('#list-group').empty();
                    userNameCurrent = userName;
                    setCookie("UserName", userName, "/");
                    $('#user-name').text(userName);
                    $.each(listGroup, function (key, value) {
                        $('#list-group').append('<option class="group-option" value=' + value.ID + '>' + value.NameGroup + '</option>');
                        //$('#list-group').append('<option class="group-option" value=' + value + '>' + value + '</option>');
                    });
                    console.log('end');
                        //listGroup.forEach(function (item) {

                        //});
                }
                //load message chat content
                chat.client.showBoxChatGroup = function (messageBoxContent) {
                    $("#form-chat-content").empty();
                    $.each(messageBoxContent,function(key,value) {
                        $("#form-chat-content").append("\r\n" + value.MessageContent);
                        //console.log(item);
                    });
                }
                //load current chat
                chat.client.sendMessage = function (username,message) {
                    $("#form-chat-content").append("\r\n"+message.toString());
                }
                //load member in group
                chat.client.loadMember = function (listMember) {
                    $('#list-member-in-group').empty();
                    $.each(listMember, function (key,value) {
                        $('#list-member-in-group').append('<li>' + value.UserName + '</li>');
                    });
                        //listMember.forEach(function (item) {

                        //});
                }
                    // Add the message to the page.
                // Start the connection.
                $.connection.hub.start().done(function () {
                    setDefault();
                    setInterval(loadDateTimeServer());
                    signIn();
                    $('#send').click(function () {
                        chat.server.upDateInfo($('#select-container').val(), $('#input-year').val());
                        // Clear text box and reset focus for next comment.
                        $('#input-year').val('').focus();
                    });
                    $('#connect').click(function () {
                        chat.server.connect($('#input-user-name').val());
                        $.connection.hub.start().done(function () {
                            // Clear text box and reset focus for next comment.
                            $('#input-user-name').val('').focus();
                        });
                    });
                    //Create group
                    $('#creat-group').click(function () {
                        chat.server.createGrouponnect($('#input-group').val(), userNameCurrent.toString());
                        // Clear text box and reset focus for next comment.
                        $('#input-group').val('').focus();
                    });
                    $('#send-message').click(function () {
                        chat.server.sendMessage(userNameCurrent.toString(), $(' #list-group').val(), $('#input-group-lg').val());
                        // Clear text box and reset focus for next comment.
                        $('#input-group-lg').val('').focus();
                    });
                    $('#add-member').click(function () {
                        chat.server.addMember(userNameCurrent.toString(), $(' #select-container-member').val(), $(' #list-group').val());
                        // Clear text box and reset focus for next comment.
                        $('#input-group-lg').val('').focus();
                    });
                    //Event choose group
                    $('#join-group').click(function () {
                        chat.server.loadBoxChatGroup(userNameCurrent.toString(), $(' #list-group').val());
                        // Clear text box and reset focus for next comment.
                        $('#input-group-lg').val('').focus();
                    });
                    //$('#send-message').click(function SelectGroup(e) {
                    //    groupCurrent = $(this).val();
                    //    chat.server.sendMessage(userNameCurrent.toString(), groupCurrent.toString());
                    //    // Clear text box and reset focus for next comment.
                    //    e.preventDefault();
                    //});
                });
                function loadDateTimeServer() {
                    chat.server.nowDate();
                    $.connection.hub.start().done(function () {
                        // Clear text box and reset focus for next comment.
                        $('#input-user-name').val('').focus();
                    });
                }
                function setDefault() {
                    chat.server.loadInfoDefault();
                }
                function signIn() {
                    var sessionUser = getCookie("UserName");
                    chat.server.connect(sessionUser);
                }
            });
        });
        function setCookie(cName, cValue, path) {
            console.log(cName + ":" + cValue);
            document.cookie = cName + "=" + cValue + ";path=" + path;
        }

        // Get Cookie
        function getCookie(cName) {
            var name = cName + "=";
            var ca = document.cookie.split(';');
            for (var i = 0; i < ca.length; i++) {
                var c = ca[i];
                while (c.charAt(0) == ' ') c = c.substring(1);
                if (c.indexOf(name) == 0) return c.substring(name.length, c.length);
            }
            return "";
        }
    </script>
}

